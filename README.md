# Сервис для сжатия ссылок
Docker version 24.0.2, build cb74dfc

docker-compose version 1.29.2, build unknown

Версии используемых пакетов прописаны в requirements.txt

Написано под Python 3.10

База данных - PostgreSQL

unit-тесты расположены в папке tests и предназначены для использования с модулем pytest

# Описание сервиса
После запуска сервиса, автодокументацию (SWAGGER) можно посмотреть открыв /docs в браузере. На этой же страницe можно поотправлять запросы в сервис

Назначение сервиса - генерировать сокращённые ссылки. Сервис записывает в БД "длинную ссылку" и на основании целочисленного ID в БД генерирует для этой ссылки последовательность символов, использование которых допустимо в URL. Использование алфавита в 64 символа делает получившиеся ссылки короче, чем если бы для создания ссылок использовались просто id ссылок в базе (для создания последовательности символов используется перевод десятичного числа в 64-ричную систему счисления).\
При переходе по этой ссылке, сервис из пути в URL получает ID ссылки в БД и производит Redirect. 

### GET /link/{short_url} 
получить оригинальный URL по короткой ссылке; short_url - короткая ссылка, закодированная при помощи percent-encoding (url-encoding)

### DELETE /link/{short_url} 
удалить короткий URL из сервиса; short_url - короткая ссылка, закодированная при помощи percent-encoding (url-encoding)

### PATCH /link/{short_url} 
обновить URL, на который будет перенаправлять короткая ссылка. short_url - короткая ссылка, закодированная при помощи percent-encoding (url-encoding); в теле запроса в формате JSON передаётся новый "длинный" URL в поле "url"

### POST /link
сгенерировать новую короткую ссылку. В теле запроса передаётся "длинный" URL, формат JSON, поле "url"

### GET /{path}
перенаправить запрос по "длинному" URL, который соответствует "короткому" URL. Только GET запросы

# Что нужно знать для деплоя
Данные для запуска сервис получает из переменных окружения
URL_COMPACTOR_HOST - хост, на котором будет развернут сервис\
URL_COMPACTOR_PORT - порт на котором будет развернут сервис\
URL_COMPACTOR_DOMAIN - домен, который будет использоваться для создания короткой ссылки (если эта переменная окружения будет равна da.net, то сервис будет генерировать короткие ссылки вида da.net/hkjhl)\
URL_COMPACTOR_DATABASE - URL базы данных, формат: postgresql+asyncpg://{username}:{password}@{host}:{port}/{dbname}\
Если деплой будет в Docker-контейнер, то данные переменные окружения должны быть прописаны в секции environment в docker-compose (либо установлены при запуске контейнера, если не используется compose).

Dockerfile.example можно использовать как готовый Dockerfile, а вот в docker-compose.yml необходимо внести изменения перед docker-compose up -d (если точнее, то нужно поменять переменные окружения в соответствии с их семантикой, описанной выше)

Создавать таблицы в БД заранее нет необходимости; если их нет, сервис на старте сам создаст нужные таблицы.


# TODO
Rate limit? Возможно, конечно, лучше это сделать на уровне какого-нибудь прокси (например, поставить nginx перед этим сервисом)? 
В любом случае, о том, что такой сервис может использоваться для спама нужно помнить
